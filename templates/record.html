<head>
<style>
  .insideWrapper {
      width:100%;
      height:100%;
      position:relative;
  }
  .coveredImage {
      width:100%;
      height:100%;
      position:absolute;
      top:0px;
      left:0px;
  }
  .coveringCanvas {
      width:100%;
      height:100%;
      position:absolute;
      top:0px;
      left:0px;
      background-color: rgba(255, 0, 0, .1);
  }

</style>
</head>
{% block body %}
<div class="outsideWrapper" >
    <div class="insideWrapper">
{% if layout == 'portrait' %}
<p onmousedown="set_xy(event)" ><img id="theImg" src="../../{{record}}" width="378" /></p>
<canvas onmousedown="set_xy(event)" class="coveringCanvas" id='myCanvas' width="378" height="968"></canvas>
<script type="text/javascript">
var width = 378;
var height = 968;
</script>
{% else %}
<canvas class="coveringCanvas" id='myCanvas'></canvas>
<div style='display:none'>
  <img class="coveredImage" id="img_src" src="../../{{record}}" width="968">
</div>
<script type="text/javascript">
var width = 968;
var height = 378;
</script>
{% endif %}
</div>
<div>

<div id="img_load"></div>
<script type="text/javascript">
var coord = Array();
var img = document.getElementById("img_src");
var cnvs = document.getElementById("myCanvas");
cnvs.addEventListener("dblclick", set_xy);
var ctx = cnvs.getContext("2d");

function mark_image(coords) {
  
  var imageObj =new Image(width, height);
  imageObj.onload = function() {
    console.log('width ' + width + 'height ' + height);
    ctx.drawImage(this ,0,0, width, height);
  };
  imageObj.src = "../../{{record}}";  
  cnvs.style.position = "absolute";
  cnvs.style.left = img.offsetLeft + "px";
  cnvs.style.top = img.offsetTop + "px";
  cnvs.width = width;
  cnvs.height = height;
  for (var i in coords) {
    console.log(coords[i])
    coord.push(coords[i])
    ctx.beginPath();
    ctx.arc(coords[i].x, coords[i].y, 10, 0, 2 * Math.PI, false);
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#00ff00';
    ctx.stroke();
  }
  ctx.save();
  ctx.globalCompositeOperation = "destination-over";
}

function set_xy(evt) {

  coord.push({'x': evt.clientX, 'y': evt.clientY});
  console.log('x' + evt.clientX + 'y' + evt.clientY);
  mark_image(coord);
 
  var x = document.getElementById("img_load");
  var createform = document.createElement('form'); // Create New Element Form
  createform.setAttribute("action", ""); // Setting Action Attribute on Form
  createform.setAttribute("method", "post"); // Setting Method Attribute on Form
  createform.setAttribute("enctype", "multipart/form-data");

  var namelabel = document.createElement('label'); // Create Label for Name Field
  namelabel.innerHTML = "Please upload file "; // Set Field Labels
  createform.appendChild(namelabel);

  var xelement = document.createElement('input');
  xelement.setAttribute("value", evt.clientX);
  xelement.setAttribute("name", "x");
  xelement.setAttribute("type", "hidden");
  createform.appendChild(xelement);

  var yelement = document.createElement('input');
  yelement.setAttribute("value", evt.clientY);
  yelement.setAttribute("name", "y");
  yelement.setAttribute("type", "hidden");
  createform.appendChild(yelement);

  // Set the description
  var inputelement = document.createElement('input');
  inputelement.setAttribute("type", "file");
  inputelement.setAttribute("name", "desc");
  createform.appendChild(inputelement);

  //Set the details 
  var detailelement = document.createElement('input');
  detailelement.setAttribute("type", "file");
  detailelement.setAttribute("name", "detail");
  createform.appendChild(detailelement);

  // Submit
  var submitelement = document.createElement('input'); // Append Submit Button
  submitelement.setAttribute("type", "submit");
  submitelement.setAttribute("name", "dsubmit");
  submitelement.setAttribute("value", "Submit");
  createform.appendChild(submitelement);

  x.appendChild(createform);

}

//document.addEventListener("click", set_xy);
</script>
<script type="text/javascript">mark_image({{coords | safe}})</script>
{% endblock %}
