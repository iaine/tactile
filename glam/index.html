<!doctype html>
<head>
<title>Turner</title>
</head>
<body>
<canvas id='myCanvas' width="968" height="950"></canvas>
<p id="log" />
<script type="text/javascript">
var el = document.getElementsByTagName("canvas")[0];
  el.addEventListener("touchstart", handleStart, false);
  el.addEventListener("touchend", handleEnd, false);
  el.addEventListener("touchcancel", handleCancel, false);
  //el.addEventListener("touchmove", handleMove, false);
  el.addEventListener("mouseup", handleEnd, false);
   log("initialising")

  // array for ongoing touches
  var onGoingTouches = []
  var touches = []
  //state for playing
  var state = 1;
  var timeMS = null;

  function handleStart(evt) {
    evt.preventDefault();
    log("touchstart.");
    /*var touches = evt.changedTouches;
        
    for (var i in touches) {
      onGoingTouches.push(touches[i]);
      log("touchstart:" + touches[i] + "."); 
    }*/
  }

  function handleCancel(evt) {
    evt.preventDefault();
    //var touches = filterItems(evt.changedTouches);
  }

  function handleEnd(evt) {
    evt.preventDefault();
    log("touchend");
    var touches = evt.changedTouches;
   
    if (touches && touches.length > 0) {
      log("x: " + touches[i].pageX + " y: " + touches[i].pageY);
      for (var i in touches) { fakeDAO(touches[i].pageX, touches[i].pageY); }; 
    } else {
      log("can't figure out which touch to end");
    }
  }
   // General Functions
  function filterItems(touches) {
    return onGoingTouches.filter(function(d) { !touches.includes(d); });
  }


  function log(msg) {
    var p = document.getElementById('log');
    p.innerHTML = msg + "\n" + p.innerHTML;
  }

var touchBuffer = null;
// Fix up prefixing
window.AudioContext = window.AudioContext || window.webkitAudioContext;
var context = new AudioContext();
var source = context.createBufferSource(); // creates a sound source
var url = './mus_audio/';
  
function fakeDAO(x, y) {
 if (x < 20) {
    if (y < 15) {
      if (state == 1) {
        state = 3;
        timeMS = Date.now()
        loadSong(url + 'overview.mp3');
      } else if (state == 3) {
        playStop();
      }
    } else if (y < 40) {
      playStop();
    }
 } else if ((x > 80 && x < 84) && (y > 363 && y < 367)) {
    loadSong(url+'windows.wav');
 } 
}
  
function loadSound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';

  // Decode asynchronously
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      touchBuffer = buffer;
      playSound(touchBuffer);
    }, onError);
  }
  request.send();
}

function playSound(buffer) {
  var source = context.createBufferSource(); // creates a sound source
  source.buffer = buffer;                    // tell the source which sound to play
  source.connect(context.destination);       // connect the source to the context's destination (the speakers)
  source.start(0);                           // play the source now
                                             // note: on older systems, may have to use deprecated noteOn(time);
}

function stopSound() {
  source.stop();
}
</script>

</body>
</html>
